# Service-based routing with separate pipelines for each service

# Entry pipeline for logs - extracts service name and routes
log-entry:
  source:
    otel_logs_source:
      port: 21892
      ssl: false

  route:
    - when: 'serviceName == "demo-web"'
      routes:
        - log-demo-web
    - when: 'serviceName == "demo-consumer"'
      routes:
        - log-demo-consumer
    - when: 'serviceName == "test-service"'
      routes:
        - log-test-service
    - default_route:
        routes:
          - log-unknown

# Demo-web logs pipeline
log-demo-web:
  source:
    pipeline:
      name: "log-entry"
  sink:
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "logs-demo-web-%{yyyy.MM.dd}"

# Demo-consumer logs pipeline
log-demo-consumer:
  source:
    pipeline:
      name: "log-entry"
  sink:
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "logs-demo-consumer-%{yyyy.MM.dd}"

# Test-service logs pipeline
log-test-service:
  source:
    pipeline:
      name: "log-entry"
  sink:
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "logs-test-service-%{yyyy.MM.dd}"

# Unknown service logs pipeline
log-unknown:
  source:
    pipeline:
      name: "log-entry"
  sink:
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "logs-unknown-%{yyyy.MM.dd}"

# Entry pipeline for traces
trace-entry:
  source:
    otel_trace_source:
      port: 21890
      ssl: false

  processor:
    - otel_traces: {}

  route:
    - when: 'serviceName == "demo-web"'
      routes:
        - trace-demo-web
    - when: 'serviceName == "demo-consumer"'
      routes:
        - trace-demo-consumer
    - when: 'serviceName == "test-service"'
      routes:
        - trace-test-service
    - default_route:
        routes:
          - trace-unknown

# Demo-web traces pipeline
trace-demo-web:
  source:
    pipeline:
      name: "trace-entry"
  sink:
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "traces-demo-web-%{yyyy.MM.dd}"

# Demo-consumer traces pipeline
trace-demo-consumer:
  source:
    pipeline:
      name: "trace-entry"
  sink:
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "traces-demo-consumer-%{yyyy.MM.dd}"

# Test-service traces pipeline
trace-test-service:
  source:
    pipeline:
      name: "trace-entry"
  sink:
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "traces-test-service-%{yyyy.MM.dd}"

# Unknown service traces pipeline
trace-unknown:
  source:
    pipeline:
      name: "trace-entry"
  sink:
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "traces-unknown-%{yyyy.MM.dd}"