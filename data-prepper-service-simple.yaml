# Service-based index routing with conditional sinks

log-pipeline:
  source:
    otel_logs_source:
      port: 21892
      ssl: false

  processor:
    # Extract service name and set appropriate index
    - mutate:
        add_entries:
          - key: "service_name"
            value: "unknown"
          - key: "index_prefix"
            value: "logs"

  sink:
    # Demo-web service logs
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "logs-demo-web-%{yyyy.MM.dd}"
        routes:
          - when: '/resource/attributes/service.name == "demo-web"'

    # Demo-consumer service logs
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "logs-demo-consumer-%{yyyy.MM.dd}"
        routes:
          - when: '/resource/attributes/service.name == "demo-consumer"'

    # Default logs for unknown services
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "logs-unknown-%{yyyy.MM.dd}"

trace-pipeline:
  source:
    otel_trace_source:
      port: 21890
      ssl: false

  processor:
    - otel_traces: {}

  sink:
    # Demo-web service traces
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "traces-demo-web-%{yyyy.MM.dd}"
        routes:
          - when: '/resource/attributes/service.name == "demo-web"'

    # Demo-consumer service traces
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "traces-demo-consumer-%{yyyy.MM.dd}"
        routes:
          - when: '/resource/attributes/service.name == "demo-consumer"'

    # Default traces for unknown services
    - opensearch:
        hosts:
          - "http://opensearch:9200"
        index: "traces-unknown-%{yyyy.MM.dd}"